<div class="lesson-viewer fade-in">
  <!-- Top Nav -->
  <div class="nav-back">
    <button mat-button routerLink="/today">
      <mat-icon>arrow_back</mat-icon> Back to Dashboard
    </button>
  </div>

  <div class="loading-overlay" *ngIf="isLoading">
    <mat-spinner diameter="40"></mat-spinner>
  </div>

  <div class="error-banner" *ngIf="error">
    <mat-icon>error</mat-icon> {{ error }}
  </div>

  <div class="detail-layout" *ngIf="lesson && !isLoading">
    <!-- Main Content Column -->
    <article class="content-column">
      <header class="lesson-hero">
        <div class="hero-badge">Lesson {{ lesson.lessonNumber }}</div>
        <h1 class="lesson-heading">{{ lesson.name }}</h1>
        <p class="lesson-lead">{{ lesson.shortDescription }}</p>
      </header>
      
      <div class="markdown-paper" *ngIf="lesson.content">
        <markdown [data]="lesson.content"></markdown>
      </div>

      <!-- Practice Section -->
      <section class="practice-section">
        <mat-card class="exercises-card">
          <mat-card-header>
            <div class="header-flex">
              <mat-card-title>Practice</mat-card-title>
              <mat-icon class="icon-faint">fitness_center</mat-icon>
            </div>
          </mat-card-header>

          <mat-card-content>
            <div class="generator-box">
              <mat-form-field appearance="outline" class="density-compact">
                <mat-label>Difficulty</mat-label>
                <mat-select [(ngModel)]="selectedDifficulty">
                  <mat-option *ngFor="let d of difficulties" [value]="d">{{ d }}</mat-option>
                </mat-select>
              </mat-form-field>

              <button mat-raised-button color="primary" (click)="generateExercise()" [disabled]="isGeneratingExercise">
                <span *ngIf="!isGeneratingExercise">Generate Task</span>
                <mat-spinner diameter="20" *ngIf="isGeneratingExercise"></mat-spinner>
              </button>
            </div>

            <div class="exercises-list">
              <mat-accordion multi>
                <mat-expansion-panel *ngFor="let exercise of lesson.exercises; let i = index" class="exercise-panel">
                  <mat-expansion-panel-header>
                    <mat-panel-title>
                      Exercise {{ i + 1 }}
                      <span class="attempts-badge" *ngIf="exercise.answers && exercise.answers.length > 0">
                        {{ exercise.answers.length }} attempt{{ exercise.answers.length > 1 ? 's' : '' }}
                      </span>
                    </mat-panel-title>
                    <mat-panel-description>{{ exercise.difficulty }}</mat-panel-description>
                  </mat-expansion-panel-header>

                  <div class="panel-body">
                    <div class="exercise-prompt">
                      <markdown [data]="exercise.exerciseText"></markdown>
                    </div>

                    <!-- Previous Attempts -->
                    <div class="feedback-history" *ngIf="exercise.answers && exercise.answers.length > 0">
                      <div class="history-label">Previous Attempts</div>
                      <div class="attempt-card" *ngFor="let answer of exercise.answers">
                        <div class="attempt-meta">
                          <span class="score-badge"
                            [class.high]="answer.accuracyLevel != null && answer.accuracyLevel >= 80"
                            [class.med]="answer.accuracyLevel != null && answer.accuracyLevel >= 50 && answer.accuracyLevel < 80"
                            [class.low]="answer.accuracyLevel != null && answer.accuracyLevel < 50"
                            *ngIf="answer.accuracyLevel != null">
                            {{ answer.accuracyLevel }}%
                          </span>
                        </div>
                        <p class="user-response">"{{ answer.userResponse }}"</p>
                        <div class="ai-review" *ngIf="answer.reviewText">
                          <markdown [data]="answer.reviewText"></markdown>
                        </div>
                      </div>
                    </div>

                    <!-- Submit New Answer -->
                    <div class="answer-section">
                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Your Answer</mat-label>
                        <textarea matInput [(ngModel)]="answerTexts[exercise.id]" rows="3" placeholder="Type your solution..."></textarea>
                      </mat-form-field>

                      <button mat-flat-button color="accent" class="submit-btn"
                        (click)="submitAnswer(exercise)"
                        [disabled]="submittingExerciseId === exercise.id || !answerTexts[exercise.id]?.trim()">
                        <mat-spinner diameter="18" *ngIf="submittingExerciseId === exercise.id"></mat-spinner>
                        <span *ngIf="submittingExerciseId !== exercise.id">Submit for Review</span>
                      </button>
                    </div>
                  </div>
                </mat-expansion-panel>
              </mat-accordion>
            </div>
          </mat-card-content>
        </mat-card>
      </section>
    </article>
  </div>
</div>